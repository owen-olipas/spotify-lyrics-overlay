<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Karaoke Overlay</title>
    <link rel="stylesheet" href="./dist/tailwind.css" />
    <style>
        .glow {
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.9),
            0 0 20px rgba(29, 185, 84, 0.4),
            0 0 30px rgba(0, 200, 255, 0.5);
        }
    </style>
</head>
<body class="app-drag select-none m-0">
    <div class="app-drag  text-white font-medium text-center items-center justify-center py-2">
        <div class="flex gap-1 items-center justify-center text-center truncate text-xs text-white/60">
            <span id="control" class="text-white/90"></span>
            <span id="track" class="text-white/90 text-center glow">Loading... </span>
            <span id="dash" class="glow"></span>
            <span id="artist" class="glow"></span>
            <span id="trailing" class="text-[rgb(29,185,84)]"></span>
        </div>

        <!-- Lyrics block -->
        <div id="lyrics" 
            class="text-base text-white/90 flex flex-col">
        </div>
    </div>

    <script>
      let currentIndex = 0;
      let lyricsLines = [];
      let startTime = Date.now();
      let isPlaying = false;

      if (window.electronAPI) {
        window.electronAPI.onTrackUpdate((data) => {
            document.getElementById("track").textContent = data.track;
            document.getElementById("artist").textContent = data.artist || "";
            document.getElementById("dash").textContent = "-";

            const control = document.getElementById("control");
            const trailing = document.getElementById("trailing");

            if (isPlaying) {
                control.textContent = "â™¬â‹†.Ëš";
                control.className = "text-[rgb(29,185,84)]";
                trailing.textContent = "âœ©â™¬â‚ŠËš."
            } else{
                control.textContent = "â–¶";
                trailing.textContent = ""
            }

            startTime = Date.now() - (data.progress || 0); // align with playback
            isPlaying = data.is_playing;
        });

        window.electronAPI.onLyricsUpdate((lyricsData) => {
            const lyricsBox = document.getElementById("lyrics");
            lyricsBox.innerHTML = ""; // reset
            lyricsLines = [];
            currentIndex = 0;
            
            if (lyricsData?.lyrics?.syncType === "UNSYNCED") {
                const nextLine = document.createElement("div");
                nextLine.textContent = "Lyrics is not synced ðŸ˜¢";
                nextLine.className = "text-white/80 text-sm flex-grow bg-gray-500/20 rounded-2xl shadow-lg backdrop-blur-sm p-2 mt-1";

                lyricsBox.appendChild(nextLine);
            } else if (lyricsData?.lyrics?.lines) {
                // Map lyrics first
                lyricsLines = lyricsData.lyrics.lines.map((l) => ({
                time: parseInt(l.startTimeMs, 10),
                words: l.words,
                }));

                // If first line starts AFTER 1000ms, prepend dummy
                if (lyricsLines.length && lyricsLines[0].time > 1000) {
                lyricsLines.unshift({ time: 0, words: "â™ª" });
                }

                // If last line is empty, replace with dummy
                if (lyricsLines.length && !lyricsLines[lyricsLines.length - 1].words.trim()) {
                lyricsLines[lyricsLines.length - 1].words = "â™ª";
                }

                currentIndex = 0;
                renderLyrics();
            } else {
                lyricsBox.textContent = "No lyrics found ðŸ˜¢";
            }
        });
        }

      function renderLyrics() {
        const lyricsBox = document.getElementById("lyrics");
        lyricsBox.innerHTML = "";

        const currentLine = document.createElement("div");
        currentLine.textContent = lyricsLines[currentIndex]?.words || "";
        currentLine.className = "glow text-xl font-bold basis-full bg-black/50 rounded-2xl shadow-lg backdrop-blur-sm p-1";

        const nextLine = document.createElement("div");
        nextLine.textContent = lyricsLines[currentIndex + 1]?.words || "";
        nextLine.className = "text-white/80 text-sm flex-grow bg-gray-500/20 rounded-2xl shadow-lg backdrop-blur-sm pb-1";

        lyricsBox.appendChild(currentLine);
        lyricsBox.appendChild(nextLine);
      }

      function syncLyrics() {
        if (!lyricsLines.length) return;

        const elapsed = Date.now() - startTime;

        // find current line based on timestamp
        let idx = lyricsLines.findIndex(
          (line, i) =>
            elapsed >= line.time &&
            (i === lyricsLines.length - 1 || elapsed < lyricsLines[i + 1].time)
        );

        if (idx !== -1 && idx !== currentIndex && isPlaying) {
          currentIndex = idx;
          renderLyrics();
        }
      }

      setInterval(syncLyrics, 300); // check 5 times per sec
    </script>
  </body>
</html>
